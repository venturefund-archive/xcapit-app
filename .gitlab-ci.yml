---
stages:
  - docker-lint
  - docker-build

image: docker:19.03.1

services:
  - docker:19.03.1-dind
    
variables:
  CONTAINER_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

###########################################################################
### Core Workflow
# # * si el commit msg comienza con [skip tests] salta los tests
# # * si el commit msg comienza con [skip smoke-test] salta el smoke-test
workflow:
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /^\[skip tests\]/ 
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^\[skip smoke-test\]/
      when: never
    - when: always

###########################################################################
# # Templates

### Docker lint
.docker-lint: &docker-lint
  stage: docker-lint
  image: hadolint/hadolint
  before_script:
    - hadolint --version
  tags:
    - coreinfra
  script:
    - hadolint --ignore DL3018 --ignore DL3006 --ignore DL3003 --ignore DL3013 --ignore DL3007 --ignore DL3002 --ignore DL3008 Dockerfile

### Build
.build-branch: &build-branch
  stage: docker-build
  tags:
    - coreinfra
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
    - docker build --tag $CONTAINER_IMAGE:$CI_COMMIT_REF_NAME .
    - docker push $CONTAINER_IMAGE:$CI_COMMIT_REF_NAME

###########################################################################
# # Test
Syntax checking:
  <<: *docker-lint
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG

Syntax checking manual:
  <<: *docker-lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never

Syntax checking push:
  <<: *docker-lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    # - when: never

##########################################################################
# # Build
Build from Tag:
  stage: docker-build
  tags:
    - coreinfra
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
    - docker build --tag $CONTAINER_IMAGE:$CI_COMMIT_TAG .
    - docker push $CONTAINER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

Build:
  <<: *build-branch
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /^\[build\]/
    - when: never

Build manual:
  <<: *build-branch
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
