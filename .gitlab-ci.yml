---
stages:
  - syntax
  - test
  - build
  - release
  - docker-build

image: docker:19.03.1
services:
  - docker:19.03.1-dind
    
variables:
  API_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
  CONTAINER_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  CI_RUNNER_REPO: registry.gitlab.com/xcapit/infra/ci-runner
  CI_RUNNER_TAG: v1.0.0
  HADOLINT_REPO: hadolint/hadolint
  HADOLINT_TAG: v2.0.0-alpine
  SRC_DIR: "."  # Indicar aqui donde esta el src code, puede ser indicado en las vars de gitlab
  NODE_VERSION: 14-alpine

cache:
  paths:
    - node_modules/

###########################################################################
###########################################################################
### Templates

### Syntax check
.syntax-check: &syntax-check
  stage: syntax
  tags:
    - coreinfra
  image: node:${NODE_VERSION}
  cache:
    untracked: true
    key: ${CI_COMMIT_REF_SLUG}
  before_script:
    - cd ${SRC_DIR}
  script:
    - node --check *.js
  allow_failure: true

### NodeJS test
.nodejs-test: &nodejs-test
  stage: test
  image: node:14
  cache:
    untracked: true
    key: ${CI_COMMIT_REF_SLUG}
  variables:
    CI: true
  tags:
    - coreinfra    
  before_script:
    - cd ${SRC_DIR}
    # - npm install --save-dev puppeteer   
    # - npm install
    # - yarn install

    - echo "deb http://dl.google.com/linux/chrome/deb/ stable main" | tee -a /etc/apt/sources.list
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    - apt-get -qq update -y
    - apt-get -qq install -y google-chrome-stable xvfb gtk2-engines-pixbuf xfonts-cyrillic xfonts-100dpi xfonts-75dpi xfonts-base xfonts-scalable imagemagick x11-apps default-jre
    - Xvfb :0 -ac -screen 0 1024x768x24 &
    - export DISPLAY=:99
    - npm install --silent --unsafe-perm -g @angular/cli@1.1.2
    - npm install --silent yarn
    - node ./node_modules/.bin/webdriver-manager update
    - yarn install
    - export CHROME_BIN=/usr/bin/google-chrome
  script:
    # - npm test --no-watch --no-progress --browsers=ChromeHeadlessNoSandbox
    - npm test --watchAll=false --coverage --forceExit

### Docker lint
.docker-lint: &docker-lint
  stage: syntax
  image: "${HADOLINT_REPO}:${HADOLINT_TAG}"
  before_script:
    - hadolint --version
    - cd ${SRC_DIR}
  tags:
    - coreinfra
  script:
    - hadolint --ignore DL3018 --ignore DL3006 --ignore DL3003 --ignore DL3013 --ignore DL3007 --ignore DL3002 --ignore DL3008 --ignore DL3042 --ignore DL3016 Dockerfile

### Semantic release
.semantic-release: &semantic-release
  stage: release
  image: "${CI_RUNNER_REPO}:${CI_RUNNER_TAG}"
  tags:
    - coreinfra

###########################################################################
###########################################################################
### Stages

# # Test
Docker Lint:
  <<: *docker-lint
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"'

### Syntax check
Syntax checking:
  <<: *syntax-check
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"'

### pytest
NodeJS Test:
  <<: *nodejs-test
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"'

### Build
Build docker image:
  stage: docker-build
  tags:
    - coreinfra
  before_script:
    - cd ${SRC_DIR}
  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
    - docker build --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

# # Release
Release Master:
  <<: *semantic-release
  only:
    refs:
    - master
  script:
    - npx semantic-release -p "@semantic-release/commit-analyzer" "@semantic-release/changelog" "@semantic-release/git" 

Release Develop:
  <<: *semantic-release
  only:
    refs:
    - develop
  script:
    - npx semantic-release --tag-format ${CI_COMMIT_BRANCH}-\${version} -p "@semantic-release/commit-analyzer" "@semantic-release/changelog" "@semantic-release/git" 
